# Exploring TGCP data

We have spent a lot of time cleaning the data, allowing us to start making visualizations.
First, we wanted to answer how many clients are living below the 30% median income line, how many are in the 30% and 60% range, and how many are above the 60% range. 
It's important to note that the thresholds for these classifcations change both by year and by the number of people that live in a household.
[You can see the thresholds for 2021 here, provided by the HOME Investment Partnerships Program.](https://www.huduser.gov/portal/datasets/home-datasets/files/HOME_IncomeLmts_State_NC_2021.pdf)
Note that we are using the threshold for Raleigh.
With all that in mind, we have categorized each client/family as being below the 30% line, between 30% and 60%, above 60%, or unknown (if the income data was unavailable).


```{r child = 'tgcp-data/median_income_bar_plots.Rmd', echo = FALSE, message = FALSE, warning = FALSE}
```

In the following plots, the Area Median Income levels are taken from the HOME Investment Parnerships Program for Raleigh in year 2021. 

```{r include=FALSE}
library(tidyverse)

data_dir<-"merged_SVI/"

GC_SVI_file<-"merged_CDC_GC.csv"

GC_SVI<-read.csv(paste0(data_dir,GC_SVI_file))
GC_SVI[GC_SVI==""]<-NA

# GC_SVI$Timestamp<-as.Date(GC_SVI$Timestamp, format ="%d-%b-%Y")

GC_SVI$Veteran[GC_SVI$Veteran=="Yes"]<-1
GC_SVI$Veteran[GC_SVI$Veteran!="1" | is.na(GC_SVI$Veteran)]<-0
GC_SVI$Veteran<-as.numeric(GC_SVI$Veteran)

GC_SVI$Incarcerated[GC_SVI$Incarcerated=="Yes"]<-1
GC_SVI$Incarcerated[GC_SVI$Incarcerated!="1"| is.na(GC_SVI$Incarcerated)]<-0
GC_SVI$Incarcerated<-as.numeric(GC_SVI$Incarcerated)

GC_SVI$Disability[GC_SVI$Disability=="Yes"]<-1
GC_SVI$Disability[GC_SVI$Disability!="1"| is.na(GC_SVI$Disability)]<-0
GC_SVI$Disability<-as.numeric(GC_SVI$Disability)

bed_req<-GC_SVI[,colnames(GC_SVI)[endsWith(colnames(GC_SVI), "BedReq")]]

for (i in 1:nrow(bed_req)){
  for (j in 1:ncol(bed_req)){
    if (is.na(bed_req[i,j])){
      bed_req[i,j]<-"0"
    }
    else{
    if (startsWith(bed_req[i,j], "Yes")){
      bed_req[i,j]<-"1"
    }
    else{
      bed_req[i,j]<-"0"
    }
    }
  }
}

##Assume that all NAs for those who have put down bed request are Nos

bed_req<-as.data.frame(lapply(bed_req,as.numeric))

GC_SVI<-cbind(GC_SVI, totalBedNeeded=rowSums(bed_req))
```

```{r include=FALSE}

### Percent Median Income by Household Size
## Wake County
sixty_wake<-c(31920,36480,41040,45600,49260,52920)

sixty_wake_df<-data.frame(id=c(1:length(sixty_wake)),inc=sixty_wake)

##To get for household size 7,8 for Wake County, assuming a linear relationship
linear_sixty_wake<-lm(inc~id,data=sixty_wake_df)

sixty_wake_pred<-data.frame(id=c(7,8),
                            inc=predict(linear_sixty_wake, 
                                        newdata=data.frame(id=c(7,8))))

sixty_wake<-rbind(sixty_wake_df,sixty_wake_pred)$inc
 

#Raleigh
sixty_ral<-c(40200,45950,51700,57450,62050,66650,71200,75800)

eighty_ral<-c(53600,61250,68900,76550,82700,88800,94950,101050)


##Assuming a linear relationship between percent median income and percent level
## i.e. linear increase in annual income level for going from 30% to 60% median 
## income level

slope<-(eighty_ral-sixty_ral)/0.2

intercept<-sixty_ral-(slope*0.6)

thirty_ral<-(slope*0.3)+intercept

thirty_wake<-thirty_ral*mean(sixty_wake/sixty_ral)

##Adding 1s and 0s for in/out of % median income level group for 30% and 60% for
## both Wake County and Raleigh areas
ral_sixty<-c()
ral_thirty<-c()
wake_sixty<-c()
wake_thirty<-c()
for (i in 1:nrow(GC_SVI)){
  inc<-GC_SVI$AnnualIncomeAmount[i]
  numhouse<-GC_SVI$TotalHHNumber[i]
  if (!is.na(numhouse) &!is.na(inc)){
    if (0<numhouse & numhouse<9){
      if (inc<=sixty_ral[numhouse]){
        ral_sixty<-append(ral_sixty,1)
      }
      else{
        ral_sixty<-append(ral_sixty,0)
      }
      if (inc<=sixty_wake[numhouse]){
        wake_sixty<-append(wake_sixty,1)
      }
      else{
        wake_sixty<-append(wake_sixty,0)
      }
      if (inc<=thirty_ral[numhouse]){
        ral_thirty<-append(ral_thirty,1)
      }
      else{
        ral_thirty<-append(ral_thirty,0)
      }
      if (inc<=thirty_wake[numhouse]){
        wake_thirty<-append(wake_thirty,1)
      }
      else{
        wake_thirty<-append(wake_thirty,0)
      }
    }
    else{
      ral_sixty<-append(ral_sixty,NA)
      ral_thirty<-append(ral_thirty,NA)
      wake_sixty<-append(wake_sixty,NA)
      wake_thirty<-append(wake_thirty,NA)
    }
  }
  else{
    ral_sixty<-append(ral_sixty,NA)
    ral_thirty<-append(ral_thirty,NA)
    wake_sixty<-append(wake_sixty,NA)
    wake_thirty<-append(wake_thirty,NA)
  }
}

GCSVI_wInc<-cbind(GC_SVI,ral_sixty,ral_thirty,wake_sixty,wake_thirty)

GCSVI_wInc<-GCSVI_wInc[!is.na(GCSVI_wInc$ral_sixty),]

```

```{r echo=FALSE}

GCSVI_numchild_sum<-as.data.frame(GCSVI_wInc %>% group_by(NumChildren) %>%
    summarize(numbelowsixty_ral=sum(ral_sixty, na.rm=T),
              numbelowthirty_ral=sum(ral_thirty, na.rm=T),
              numbelowsixty_wake=sum(wake_sixty, na.rm=T),
              numbelowthirty_wake=sum(wake_thirty, na.rm=T)))
  

GCSVI_numchild_sum<-GCSVI_numchild_sum[!is.na(GCSVI_numchild_sum$NumChildren),]

numchild_for_plot<-gather(GCSVI_numchild_sum, key="inc_type", value="numBelow", 
                          c(numbelowthirty_wake,numbelowsixty_wake))

ggplot(numchild_for_plot, aes(x=NumChildren, y=numBelow, fill=inc_type))+
  geom_bar(stat="identity", position="dodge")+labs(x="Number of Children",
  y="Number Below Median Percentile", 
  title="Number of Children by Income Percentile")+
  scale_fill_discrete(name="Median Income Percentile", 
                      labels=c("Below 60% Median Wake",
                              "Below 30% Median Wake"))
```
Some things to note:

* We see that the number of all of those below a certain median income level maximizes around two children, and drops off with more children



```{r echo=FALSE}

GCSVI_queen_sum<-as.data.frame(GCSVI_wInc %>% group_by(QueenBeds) %>%
    summarize(numbelowsixty_ral=sum(ral_sixty, na.rm=T),
              numbelowthirty_ral=sum(ral_thirty, na.rm=T),
              numbelowsixty_wake=sum(wake_sixty, na.rm=T),
              numbelowthirty_wake=sum(wake_thirty, na.rm=T)))
  

GCSVI_queen_sum<-GCSVI_queen_sum[!is.na(GCSVI_queen_sum$QueenBeds),]

queen_for_plot<-gather(GCSVI_queen_sum, key="inc_type", value="numBelow", 
                          c(numbelowthirty_wake,numbelowsixty_wake))

ggplot(queen_for_plot, aes(x=QueenBeds, y=numBelow, fill=inc_type))+
  geom_bar(stat="identity", position="dodge")+labs(x="Number Queen Beds Needed",
  y="Number Below Median Percentile", 
  title="Number Queen Beds by Income Percentile")+
  scale_fill_discrete(name="Median Income Percentile", 
                      labels=c("Below 60% Median Wake",
                              "Below 30% Median Wake"))
```
Some things to note:

* Most people who need a queen bed are not below a certain median income level



```{r echo=FALSE}

GCSVI_twin_sum<-as.data.frame(GCSVI_wInc %>% group_by(TwinBeds) %>%
    summarize(numbelowsixty_ral=sum(ral_sixty, na.rm=T),
              numbelowthirty_ral=sum(ral_thirty, na.rm=T),
              numbelowsixty_wake=sum(wake_sixty, na.rm=T),
              numbelowthirty_wake=sum(wake_thirty, na.rm=T)))
  

GCSVI_twin_sum<-GCSVI_twin_sum[!is.na(GCSVI_twin_sum$TwinBeds),]

twin_for_plot<-gather(GCSVI_twin_sum, key="inc_type", value="numBelow", 
                          c(numbelowthirty_wake,numbelowsixty_wake))

ggplot(twin_for_plot, aes(x=TwinBeds, y=numBelow, fill=inc_type))+
  geom_bar(stat="identity", position="dodge")+labs(x="Number Twin Beds Needed",
  y="Number Below Median Percentile", 
  title="Number Twin Beds by Income Percentile")+
  scale_fill_discrete(name="Median Income Percentile", 
                      labels=c("Below 60% Median Wake",
                              "Below 30% Median Wake"))
```
Some things to note:

* Most people who need a twin bed are not below a certain median income level



```{r echo=FALSE}

order_POV<-GCSVI_wInc[order(GCSVI_wInc$EP_POV),]

acc_ral_thirty<-c(order_POV$ral_thirty[1])
acc_ral_sixty<-c(order_POV$ral_sixty[1])
acc_wake_thirty<-c(order_POV$wake_thirty[1])
acc_wake_sixty<-c(order_POV$wake_sixty[1])
for (i in 2:nrow(order_POV)){
  acc_ral_thirty<-append(acc_ral_thirty,order_POV$ral_thirty[i]+
                           acc_ral_thirty[i-1])
  acc_ral_sixty<-append(acc_ral_sixty,order_POV$ral_sixty[i]+
                          acc_ral_sixty[i-1])
  acc_wake_thirty<-append(acc_wake_thirty,order_POV$wake_thirty[i]+
                            acc_wake_thirty[i-1])
  acc_wake_sixty<-append(acc_wake_sixty,order_POV$wake_sixty[i]+
                           acc_wake_sixty[i-1])
}

order_POV<-cbind(order_POV,
                 acc_wake_thirty, acc_wake_sixty)

order_POV_plot<-gather(order_POV, key="inc_type", value="accuml", 
                       c(acc_wake_thirty, 
                         acc_wake_sixty))

ggplot(order_POV_plot, aes(x=EP_POV, y=accuml, color=inc_type))+geom_line()+
  labs(x="Percent Poverty Less Than or Equal",y="Number Below Median Percentile",
       title="Percent Poverty by Income Percentile")+
  scale_color_discrete(name="Median Income Percentile", 
                       labels=c("Below 60% Median Wake",
                                "Below 30% Median Wake"))
```
Some things to note:

* We see that the number of people below a certain income level accumulates at much larger steps as one's area surpasses a certain percent of impoverishment. Note: the percent poverty is taken from the CDC SVIs (see next section).

\newpage

We have also looked at the total number of beds provided to clients (number of twins and queens combined).
Again, since this may changed based on the number of members of a household, we have stratified.

```{r child = 'Long Format Data set/beds_by_people.Rmd', echo = FALSE, message = FALSE, warning = FALSE}
```

\newpage

Next we wanted to investigate which agencies refered the most clients.
From this, we can get a better grasp on where the clients are coming from and how to best serve them.
These are the ten agencies that refer the most clients. 

```{r, echo=FALSE, message = FALSE, warning = FALSE}
## Common Agencies

# Setting up
library(readxl)
library(writexl)
library(tidyverse)

# Read in raw data
tgcp_demog <- read_excel("STATCOM_data.xlsx", col_types = "text")
tgcp_demog <- rename(tgcp_demog, Id = `...1`)

# Viewing the data
#View(tail(tgcp_demog[, c(1:40, 119:128)], n = 100))

# List of Agencies -- needs to be cleaned
#ggplot(data = tgcp_demog, aes(x = Agency)) + geom_histogram(stat = "count")
agency_table <- as.data.frame(table(tgcp_demog$Agency))
colnames(agency_table) <- c("Agency","Freq")
# View(agency_table)

# Write to spreadsheet for data cleaning
# write_xlsx(agency_table, 
          # "C:\\Users\\shakt\\OneDrive\\Documents\\NC State\\TGCP\\the green chair project\\AgencyNames.xlsx")

# Reading in new spreadsheet with duplicate rows for cleaned names
agency_clean <- read_excel("AgencyNames.xlsx", range = cell_cols("B:D"))
# View(agency_clean)

# Aggregating duplicate rows to update frequency count
agency_clean2 <- aggregate(Freq~Agency_Clean_Short, 
                           data = agency_clean, FUN=sum)

## Visualizing the agency data
# Not very useful plot (too many variables)
#ggplot(data = agency_clean, aes(x = Agency_Clean_Short)) + geom_bar()

# Top 10 Agencies only
agency_clean2 %>% arrange(desc(Freq)) %>%
  slice(1:10) %>%
  mutate(agency_rank = fct_reorder(Agency_Clean_Short, Freq),
         highlight =
           ifelse(Agency_Clean_Short %in%
                              Agency_Clean_Short[which.max(Freq)],T,F)) %>%
  ggplot(., aes(x=factor(agency_rank),y=Freq)) +
  # geom_bar(stat = 'identity', aes(fill=highlight)) +
  # scale_fill_manual(values = c("grey50","#6BBF4E")) +
    geom_bar(stat = 'identity') +
  coord_flip() +
  theme(axis.text.y = element_text(size = 7, angle = 45),
        legend.position = "none") +
  labs(title = "Top 10 Agencies",
       x = "", y = "") 

```

As expected, the Wake Country Public School System was referred the most by far, with nearly 1200 referrals. 
This has encouraged us to look further into the schools.
We are compiling data including drop out/graduation rates, test scores, and free and reduced lunch participation for each public school in Wake county.
Then we will be able to cross reference this with our data to find correlations between clients referred to TGCP and these external, school variables.
Here we present the schools with the highest percentage of their students enrolled in the free and reduced lunch program as well as the schools with most highest total number of students enrolled in a lunch program.

```{r child = 'school_data/lunch_plot.Rmd', echo = FALSE, message = FALSE, warning = FALSE}
```
