---
title: "Met and Unmet Needs Mapping"
author: "Alvin Sheng"
date: "11/26/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center', fig.width = 5, fig.height = 3)
```

```{r}
library(here)
library(tidyverse)

library(choroplethr)

library(choroplethrZip)
library(choroplethrMaps)

library(usmap)
```

```{r}
tgcp_svi <- readRDS(here("cleaned_STATCOM_data_SVI.rds"))
```

There are 634 (12%) clients with missing zip codes. Thus, the maps show only the clients with non-missing zip codes.

```{r}
zip_code_summary <- tgcp_svi[!is.na(tgcp_svi$ClientZipCode), ] %>% group_by(ClientZipCode) %>% summarise(num_clients = n(), prop_clients = n() / nrow(tgcp_svi))

zip_code_num_clients <- data.frame(region = as.character(zip_code_summary$ClientZipCode), 
                                   value = zip_code_summary$num_clients)

zip_code_prop_clients <- data.frame(region = as.character(zip_code_summary$ClientZipCode), 
                                   value = round(zip_code_summary$prop_clients, digits = 3))

```

```{r}
data(zip.regions)

zip_list <- zip_code_num_clients$region

north_carolina_zip <- zip.regions$region[zip.regions$state.name == "north carolina"]

virginia_zip <- zip.regions$region[zip.regions$state.name == "virginia"]

west_virginia_zip <- zip.regions$region[zip.regions$state.name == "west virginia"]

atleast5_zip <- zip_code_num_clients$region[zip_code_num_clients$value > 4 &
                                                      !is.na(zip_code_num_clients$region)]
```

```{r}
zip_code_summary_subset <- zip_code_summary[zip_code_summary$ClientZipCode %in% atleast5_zip, ]

score <- rank(zip_code_summary_subset$num_clients, ties.method = "average")
# score <- score / max(score)

zip_code_rank_num_clients <- data.frame(region = as.character(zip_code_summary_subset$ClientZipCode), 
                                   value = score)
```



```{r, echo = F}
# to get Google reference map (https://arilamstein.com/blog/2019/05/21/bug-when-creating-reference-maps-with-choroplethr/)

library(ggmap)
register_google("<your api key>")

```



First, mapping all the zip codes in the data set, in North Carolina. 

For the zip codes that are not in North Carolina, one zip code is from Virginia (with one client), one zip code is from West Virginia (with one client) and the rest are typos. 

<!-- The tgcp_svi dataset  -->

```{r}


# manhattan_les = c("10002", "10003", "10009")
# manhattan_ues = c("10021", "10028", "10044", "10128")
zip_choropleth(zip_code_num_clients,
               # zip_zoom = c(manhattan_les, manhattan_ues),
               state_zoom = c("north carolina"),
               title    = "Number of Clients",
               legend   = "Number of Clients", 
               num_colors = 9)
```



<!-- Finding the counties with >= 5 clients -->

```{r}
zip.regions.tgcp <- zip.regions[zip.regions$region %in% atleast5_zip, ]

tgcp_county_name_code <- unique(cbind(zip.regions.tgcp$county.name, zip.regions.tgcp$county.fips.numeric))
```

```{r}
harnett_zip <- zip.regions$region[zip.regions$county.name == "harnett"]
johnston_zip <- zip.regions$region[zip.regions$county.name == "johnston"]
chatham_zip <- zip.regions$region[zip.regions$county.name == "chatham"]
wake_zip <- zip.regions$region[zip.regions$county.name == "wake"]
durham_zip <- zip.regions$region[zip.regions$county.name == "durham"]
orange_zip <- zip.regions$region[zip.regions$county.name == "orange"]
franklin_zip <- zip.regions$region[zip.regions$county.name == "franklin"]
nash_zip <- zip.regions$region[zip.regions$county.name == "nash"]
granville_zip <- zip.regions$region[zip.regions$county.name == "granville"]
```

```{r, eval = F}
intersect(atleast5_zip, harnett_zip) # contained within other counties

intersect(atleast5_zip, johnston_zip)

intersect(atleast5_zip, chatham_zip) # contained within other counties

intersect(atleast5_zip, wake_zip)

intersect(atleast5_zip, durham_zip)

intersect(atleast5_zip, orange_zip)

intersect(atleast5_zip, franklin_zip)

intersect(atleast5_zip, nash_zip) # contained within franklin

intersect(atleast5_zip, granville_zip) # contained within franklin
```

```{r}
intersect(atleast5_zip, johnston_zip)

intersect(atleast5_zip, wake_zip)

intersect(atleast5_zip, durham_zip)

intersect(atleast5_zip, orange_zip)

intersect(atleast5_zip, franklin_zip)
```


Five counties contain all the zip codes with at least 5 clients: Johnston, Wake, Durham, Orange, and Franklin

```{r}
usmap::plot_usmap("counties", fill = "yellow", alpha = 0.25,
                  include = c("37101", "37183", "37063", "37135", "37069"), 
                  labels = T) +
                  labs(title = "Counties Serviced by TGCP")
```



```{r, eval=FALSE}
zip_code_num_clients[!(zip_code_num_clients$region %in% north_carolina_zip) & !is.na(zip_code_num_clients$region),]
```

```{r, eval=FALSE}
zip_code_num_clients[(zip_code_num_clients$region %in% north_carolina_zip) & !is.na(zip_code_num_clients$region) & !(zip_code_num_clients$region %in% atleast5_zip),]
```

```{r, eval=FALSE}
zip_code_num_clients[(zip_code_num_clients$region %in% north_carolina_zip) & !is.na(zip_code_num_clients$region) & !(zip_code_num_clients$region %in% wake_zip),]
```



```{r}

zip_choropleth(zip_code_num_clients,
               zip_zoom = atleast5_zip,
               title    = "Number of Clients",
               legend   = "Number of Clients", 
               num_colors = 9)

```

```{r, eval = F}

zip_choropleth(zip_code_num_clients,
               zip_zoom = intersect(atleast5_zip, wake_zip),
               title    = "Number of Clients",
               legend   = "Number of Clients", 
               num_colors = 9)

```

```{r, eval = F}

zip_choropleth(zip_code_prop_clients,
               zip_zoom = atleast5_zip,
               title    = "Proportion of Clients",
               legend   = "Proportion of Clients", 
               num_colors = 9)

```



```{r}

zip_choropleth(zip_code_rank_num_clients,
               zip_zoom = atleast5_zip,
               title    = "Ranking of the Number of Clients",
               legend   = "Rank", 
               num_colors = 9)

```

```{r, eval = F}

zip_choropleth(zip_code_rank_num_clients,
               zip_zoom = intersect(atleast5_zip, wake_zip),
               title    = "Ranking of the Number of Clients",
               legend   = "Rank", 
               num_colors = 9)

```



```{r, eval = F}

zip_choropleth(zip_code_num_clients,
               # zip_zoom = c(manhattan_les, manhattan_ues),
               county_zoom = c("37101", "37183", "37063", "37135", "37069"),
               title    = "Number of Clients",
               legend   = "Number of Clients", 
               num_colors = 9)

```



# Unmet Needs Plot

```{r}
# tgcp_atleast5 <- tgcp_svi[tgcp_svi$ClientZipCode %in% atleast5_zip, ]

tgcp_pci <- unique(cbind(tgcp_svi$ClientZipCode[!is.na(tgcp_svi$ClientZipCode)],
                         tgcp_svi$EP_PCI[!is.na(tgcp_svi$ClientZipCode)]))

zip_code_pci <- data.frame(region = as.character(tgcp_pci[, 1]), value = tgcp_pci[, 2])

tgcp_pci_subset <- tgcp_pci[tgcp_pci[, 1] %in% atleast5_zip, ]

score <- rank(-tgcp_pci_subset[, 2], ties.method = "average", na.last = "keep")
# score <- score / max(score, na.rm = T)

zip_code_rank_pci <- data.frame(region = as.character(tgcp_pci_subset[, 1]), 
                                value = score)
```



```{r}
zip_choropleth(zip_code_pci,
               zip_zoom = atleast5_zip,
               title    = "Per Capita Income of Clients",
               legend   = "Per Capita Income", 
               num_colors = 9)
```

```{r}
zip_choropleth(zip_code_rank_pci,
               zip_zoom = atleast5_zip,
               title    = "Ranking of Need (corresponding to lower PCI)",
               legend   = "Ranking", 
               num_colors = 9)
```

Difference of the "met" and "unmet" need rankings

```{r}
zip_code_rank_num_pci <- left_join(zip_code_rank_num_clients, zip_code_rank_pci, by = "region")

zip_code_rank_diff <- data.frame(region = zip_code_rank_num_pci$region, value = zip_code_rank_num_pci$value.y - zip_code_rank_num_pci$value.x)

# zip_code_rank_diff_rank <- data.frame(region = zip_code_rank_num_pci$region, value = rank(zip_code_rank_diff$value))
```

```{r}
zip_choropleth(zip_code_rank_diff,
               zip_zoom = atleast5_zip,
               title    = "Unmet Need",
               legend   = "Rank Difference", 
               num_colors = 9)
```

<!-- ```{r} -->
<!-- zip_choropleth(zip_code_rank_diff_rank, -->
<!--                zip_zoom = atleast5_zip, -->
<!--                title    = "Unmet Need, Ranked", -->
<!--                legend   = "Rank",  -->
<!--                num_colors = 9) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- zip_choropleth(zip_code_rank_diff_rank, -->
<!--                zip_zoom = intersect(atleast5_zip, wake_zip), -->
<!--                title    = "Unmet Need, Ranked", -->
<!--                legend   = "Rank",  -->
<!--                num_colors = 9) -->
<!-- ``` -->

<!-- To-do: point out the zip codes in tabular format with most unmet need -->

```{r}
zip_choropleth(zip_code_rank_diff,
               zip_zoom = atleast5_zip,
               title    = "Unmet Need",
               legend   = "Rank Difference", 
               num_colors = 9, 
               reference_map = T)
```

<!-- ```{r} -->
<!-- zip_choropleth(zip_code_rank_diff_rank, -->
<!--                zip_zoom = intersect(atleast5_zip, wake_zip), -->
<!--                title    = "Unmet Need, Ranked", -->
<!--                legend   = "Rank",  -->
<!--                num_colors = 9,  -->
<!--                reference_map = T) -->
<!-- ``` -->

<!-- should rescale the ranking, to be more comparable -->



